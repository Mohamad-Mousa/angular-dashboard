<div class="assessment-container">
  <div class="card border-0 shadow-sm mb-4">
    <div class="card-body">
      <div class="d-flex flex-wrap align-items-center justify-content-between gap-3 mb-4">
        <div>
          <button
            type="button"
            class="btn btn-link text-decoration-none p-0 d-flex align-items-center mb-2"
            (click)="cancelAssessment()"
          >
            <span class="material-symbols-rounded me-2">arrow_back</span>
            <span>Back to Assessments</span>
          </button>
          <h2 class="h4 mb-0">New AI Readiness Assessment</h2>
        </div>
        <div class="d-flex gap-2">
          <app-button
            label="Save Progress"
            size="sm"
            variant="outline"
            icon="save"
            [loading]="isSaving"
            (click)="saveAssessment()"
          ></app-button>
          <app-button
            label="Complete Assessment"
            size="sm"
            variant="primary"
            icon="check_circle"
            [disabled]="assessment.overallProgress < 100"
            (click)="completeAssessment()"
          ></app-button>
        </div>
      </div>

      <!-- Assessment Info -->
      <div class="row g-3 mb-4">
        <div class="col-md-6">
          <label class="form-label">Assessment Name <span class="text-danger">*</span></label>
          <input
            type="text"
            class="form-control"
            placeholder="e.g., Q1 2024 AI Readiness Assessment"
            [(ngModel)]="assessment.name"
          />
        </div>
        <div class="col-md-6">
          <label class="form-label">Description</label>
          <input
            type="text"
            class="form-control"
            placeholder="Brief description of this assessment"
            [(ngModel)]="assessment.description"
          />
        </div>
      </div>

      <!-- Overall Progress -->
      <div class="mb-4">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <span class="text-muted small">Overall Progress</span>
          <strong>{{ assessment.overallProgress | number: '1.0-0' }}%</strong>
        </div>
        <div class="progress" style="height: 10px;">
          <div
            class="progress-bar"
            role="progressbar"
            [style.width.%]="assessment.overallProgress"
            [attr.aria-valuenow]="assessment.overallProgress"
            aria-valuemin="0"
            aria-valuemax="100"
          ></div>
        </div>
      </div>

      <!-- Domain Navigation -->
      <div class="domains-navigation">
        <div class="row g-2">
          @for (domain of assessment.domains; track domain.id; let i = $index) {
            <div class="col-6 col-md-4 col-lg">
              <button
                type="button"
                class="domain-nav-btn w-100 p-2 rounded border-0"
                [class.active]="currentDomainIndex === i"
                [class.completed]="domain.completed"
                (click)="selectDomain(i)"
              >
                <span class="material-symbols-rounded d-block mb-1">{{ domain.icon }}</span>
                <small class="d-block fw-semibold">{{ domain.name }}</small>
                <div class="progress mt-2" style="height: 4px;">
                  <div
                    class="progress-bar"
                    [class.bg-success]="domain.completed"
                    role="progressbar"
                    [style.width.%]="domain.progress"
                  ></div>
                </div>
              </button>
            </div>
          }
        </div>
      </div>
    </div>
  </div>

  <!-- Question Interface -->
  <div class="card border-0 shadow-sm">
    <div class="card-body">
      <!-- Domain Header -->
      <div class="d-flex align-items-start gap-3 mb-4">
        <span class="material-symbols-rounded domain-header-icon">{{ currentDomain.icon }}</span>
        <div class="flex-grow-1">
          <h4 class="mb-1">{{ currentDomain.name }}</h4>
          <p class="text-muted small mb-0">{{ currentDomain.description }}</p>
          <div class="mt-2">
            <span class="badge bg-primary-subtle text-primary-emphasis">
              Question {{ currentQuestionIndex + 1 }} of {{ currentDomain.questions.length }}
            </span>
          </div>
        </div>
      </div>

      <!-- Question -->
      <div class="question-container mb-4">
        <label class="form-label fw-semibold mb-3">
          {{ currentQuestion.text }}
          @if (currentQuestion.required) {
            <span class="text-danger">*</span>
          }
        </label>

        @switch (currentQuestion.type) {
          @case ('text') {
            <input
              type="text"
              class="form-control"
              [(ngModel)]="currentQuestion.answer"
              (ngModelChange)="calculateProgress()"
            />
          }
          @case ('textarea') {
            <textarea
              class="form-control"
              rows="4"
              [(ngModel)]="currentQuestion.answer"
              (ngModelChange)="calculateProgress()"
            ></textarea>
          }
          @case ('select') {
            <select
              class="form-select"
              [(ngModel)]="currentQuestion.answer"
              (ngModelChange)="calculateProgress()"
            >
              <option [value]="undefined">Select an option</option>
              @for (option of currentQuestion.options; track option) {
                <option [value]="option">{{ option }}</option>
              }
            </select>
          }
          @case ('file') {
            <div>
              <input
                type="file"
                class="form-control"
                multiple
                (change)="onFileChange($event, currentQuestion)"
              />
              @if (currentQuestion.evidenceFiles && currentQuestion.evidenceFiles.length > 0) {
                <div class="mt-3">
                  <small class="text-muted d-block mb-2">Uploaded files:</small>
                  @for (file of currentQuestion.evidenceFiles; track $index; let i = $index) {
                    <div class="d-flex align-items-center justify-content-between bg-light p-2 rounded mb-2">
                      <span class="small">
                        <span class="material-symbols-rounded me-1" style="font-size: 16px;">description</span>
                        {{ file.name }}
                      </span>
                      <button
                        type="button"
                        class="btn btn-sm btn-link text-danger p-0"
                        (click)="removeFile(currentQuestion, i)"
                      >
                        <span class="material-symbols-rounded" style="font-size: 18px;">close</span>
                      </button>
                    </div>
                  }
                </div>
              }
            </div>
          }
        }
      </div>

      <!-- Navigation Buttons -->
      <div class="d-flex justify-content-between align-items-center">
        <app-button
          label="Previous"
          size="md"
          variant="outline"
          icon="arrow_back"
          [disabled]="!hasPreviousQuestion && !hasPreviousDomain"
          (click)="previousQuestion()"
        ></app-button>

        <div class="text-center">
          <small class="text-muted">
            Domain {{ currentDomainIndex + 1 }} of {{ assessment.domains.length }}
          </small>
        </div>

        @if (hasNextQuestion || hasNextDomain) {
          <button
            type="button"
            class="btn btn-primary"
            (click)="nextQuestion()"
          >
            <span>Next</span>
            <span class="material-symbols-rounded ms-1 align-middle">arrow_forward</span>
          </button>
        } @else {
          <button
            type="button"
            class="btn btn-primary"
            [disabled]="!canCompleteDomain"
            (click)="completeAssessment()"
          >
            <span>Review</span>
            <span class="material-symbols-rounded ms-1 align-middle">check_circle</span>
          </button>
        }
      </div>
    </div>
  </div>
</div>

