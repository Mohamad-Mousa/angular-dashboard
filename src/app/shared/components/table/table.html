<div class="table-wrapper" [class.is-loading]="loading">
  @if (loading) {
  <app-loader class="table-loader" variant="overlay" [label]="loadingLabel"></app-loader>
  }
  @if (enableFilters) {
  <div class="table-filters gap-3">
    @if (enableGlobalSearch) {
    <div class="filter-control flex-grow-1">
      <label class="form-label text-uppercase text-muted small mb-1">
        Keyword
      </label>
      <input #keywordInput type="text" class="form-control form-control-sm" placeholder="Search..."
        [value]="globalSearch" (input)="onGlobalSearchChange(keywordInput.value)" />
    </div>
    }

    @for (column of columns; track column.key) {
    @if (column.filterable !== false && (column.filterType ?? 'text') === 'select') {
    <div class="filter-control">
      <label class="form-label text-uppercase text-muted small mb-1">
        {{ column.label }}
      </label>
      <select #filterSelect class="form-select form-select-sm" [value]="filterValue(column.key)"
        (change)="onFilterChange(column.key, filterSelect.value)">
        <option value="">All</option>
        @for (option of (column.filterOptions ?? []); track optionIndex; let optionIndex = $index) {
        @if (typeof option === 'string') {
        <option [value]="option">{{ option }}</option>
        } @else {
        <option [value]="option.value">{{ option.label }}</option>
        }
        }
      </select>
    </div>
    }
    }
  </div>
  }
  <div class="table-responsive">
    <table class="table align-middle mb-0">
      <thead>
        <tr>
          @for (column of columns; track column.key) {
          <th scope="col">
            <button class="sort-button" type="button" [disabled]="!enableSorting || column.sortable === false"
              (click)="toggleSort(column)">
              <span>{{ column.label }}</span>
              @if (enableSorting && column.sortable !== false) {
              <span class="sort-indicator" [class.active]="activeSortColumn === column.key">
                @if (activeSortColumn === column.key) {
                <span class="material-symbols-rounded" aria-hidden="true">
                  {{ activeSortDirection === 'asc' ? 'arrow_upward' : 'arrow_downward' }}
                </span>
                } @else {
                <span class="material-symbols-rounded" aria-hidden="true">unfold_more</span>
                }
              </span>
              }
            </button>
          </th>
          }
          @if (showActions) {
          <th scope="col" class="text-end">Actions</th>
          }
        </tr>
      </thead>
      <tbody>
        @if (processedRows.length) {
        @for (row of processedRows; track row; let idx = $index) {
        <tr [class.row-open]="openRowIndex === idx && showActions">
          @for (column of columns; track column.key) {
          <td>
            @switch (column.type) {
            @case ('badge') {
            <app-status-pill [label]="cellLabel(row, column)" [tone]="badgeClassFor(row, column)"
              size="sm"></app-status-pill>
            }
            @case ('image') {
            @if (getImageUrl(row, column)) {
            <img [src]="getImageUrl(row, column)" [alt]="column.label" class="table-image" />
            } @else {
            <span class="text-muted">—</span>
            }
            }
            @default {
            <span>{{ row[column.key] ?? '—' }}</span>
            }
            }
          </td>
          }
          @if (showActions) {
          <td class="text-end">
            <div class="action-dropdown" (click)="$event.stopPropagation()">
              <button class="action-trigger btn btn-sm" type="button" aria-label="Row actions"
                [attr.aria-expanded]="openRowIndex === idx" (click)="toggleActions(idx)">
                <span class="material-symbols-rounded" aria-hidden="true">
                  more_horiz
                </span>
              </button>
              <ul class="action-dropdown-menu" [class.show]="openRowIndex === idx">
                @for (action of actionKeys; track action) {
                <li>
                  <button class="dropdown-item" type="button" [disabled]="!actionEnabled(row, action)"
                    (click)="onActionClick(row, action)">
                    <span class="material-symbols-rounded dropdown-icon" aria-hidden="true">
                      {{ actionIcons[action] }}
                    </span>
                    <span>{{ actionLabels[action] }}</span>
                  </button>
                </li>
                }
              </ul>
            </div>
          </td>
          }
        </tr>
        }
        } @else {
        <tr>
          <td [attr.colspan]="columns.length + (showActions ? 1 : 0)" class="text-center text-muted py-4">
            {{ emptyMessage }}
          </td>
        </tr>
        }
      </tbody>
    </table>
  </div>
  @if (enablePagination && totalCount > 0) {
  <div class="table-pagination">
    <div class="pagination-info">
      <span class="text-muted small">
        Showing {{ startIndex }} to {{ endIndex }} of {{ totalCount }} entries
      </span>
    </div>
    <div class="pagination-controls">
      <div class="pagination-size-selector">
        <!-- <label class="form-label text-uppercase text-muted small mb-1">
          Per Page
        </label> -->
        <select class="form-select form-select-sm" [value]="pageSize"
          (change)="onPageSizeChange(+$any($event.target).value)">
          @for (size of pageSizeOptions; track size) {
          <option [value]="size">{{ size }}</option>
          }
        </select>
      </div>
      <div class="pagination-buttons">
        <button class="btn btn-sm btn-outline-secondary" type="button" [disabled]="!hasPreviousPage || loading"
          (click)="firstPage()" aria-label="First page">
          <span class="material-symbols-rounded" aria-hidden="true">first_page</span>
        </button>
        <button class="btn btn-sm btn-outline-secondary" type="button" [disabled]="!hasPreviousPage || loading"
          (click)="previousPage()" aria-label="Previous page">
          <span class="material-symbols-rounded" aria-hidden="true">chevron_left</span>
        </button>
        <span class="pagination-page-info">
          Page {{ currentPage }} of {{ totalPages }}
        </span>
        <button class="btn btn-sm btn-outline-secondary" type="button" [disabled]="!hasNextPage || loading"
          (click)="nextPage()" aria-label="Next page">
          <span class="material-symbols-rounded" aria-hidden="true">chevron_right</span>
        </button>
        <button class="btn btn-sm btn-outline-secondary" type="button" [disabled]="!hasNextPage || loading"
          (click)="lastPage()" aria-label="Last page">
          <span class="material-symbols-rounded" aria-hidden="true">last_page</span>
        </button>
      </div>
    </div>
  </div>
  }
</div>